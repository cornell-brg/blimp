

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Functional-Level Processor &mdash; Blimp  documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/logo.css?v=0320fe47" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/wavedrom.css?v=4f1d019f" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/table.css?v=09be579f" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/image.css?v=c42c1b78" />

  
    <link rel="shortcut icon" href="../../_static/blimp_favicon.png"/>
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=187304be"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="https://wavedrom.com/skins/default.js"></script>
      <script src="https://wavedrom.com/wavedrom.min.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex/" />
    <link rel="search" title="Search" href="../../search/" />
    <link rel="next" title="Memory-Mapped Peripherals" href="../../fpga/peripherals/" />
    <link rel="prev" title="Assembler and Disassembler" href="../assembler/" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../" class="icon icon-home">
            Blimp
              <img src="../../_static/blimp_no_border.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search/" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Overview</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../overview/motivation/">Design Motivation and Philosophy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../overview/data_flow/">Data Flow in the Processor</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../overview/versions/">Processor Versions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../overview/repository_structure/">Repository Structure</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../overview/build_system/">Build System</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../overview/dependencies/">Dependencies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../overview/todo/">Further Work</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Functional Level (FL) Utilities</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../assembler/">Assembler and Disassembler</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Functional-Level Processor</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#helper-classes">Helper Classes</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#instructions-flinst">Instructions (<code class="docutils literal notranslate"><span class="pre">FLInst</span></code>)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#register-file-flregfile">Register File (<code class="docutils literal notranslate"><span class="pre">FLRegfile</span></code>)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#memory-flmem">Memory (<code class="docutils literal notranslate"><span class="pre">FLMem</span></code>)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#peripherals-flperipheral">Peripherals (<code class="docutils literal notranslate"><span class="pre">FLPeripheral</span></code>)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#instruction-traces-fltrace">Instruction Traces (<code class="docutils literal notranslate"><span class="pre">FLTrace</span></code>)</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#functional-level-processor-implementation">Functional-Level Processor Implementation</a></li>
<li class="toctree-l2"><a class="reference internal" href="#interfacing-with-verilog-testbenches">Interfacing with Verilog Testbenches</a></li>
<li class="toctree-l2"><a class="reference internal" href="#running-programs-on-the-processor">Running Programs on the Processor</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">FPGA Implementation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../fpga/peripherals/">Memory-Mapped Peripherals</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fpga/network/">Memory Network</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Demonstrations</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../demos/sim_demo/">Modifying Blimp</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../demos/quartus_demo/">Colossal Cave Demo</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../">Blimp</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Functional-Level Processor</li>
      <li class="wy-breadcrumbs-aside">
              <a href="https://github.com/cornell-brg/blimp/blob/main/docs/fl/proc.rst" class="fa fa-github"> Edit on GitHub</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="functional-level-processor">
<h1>Functional-Level Processor<a class="headerlink" href="#functional-level-processor" title="Link to this heading"></a></h1>
<p>In addition to the RTL processor implementations, a functional-level (FL)
processor was developed with RV32IM support. This processor implementation
was aimed towards testing, and served two purposes:</p>
<ul class="simple">
<li><p>Verification of tests with specified inputs and outputs (directed
testing)</p></li>
<li><p>For any given input stream, production of expected outputs to compare
with RTL model outputs (golden reference model testing)</p></li>
</ul>
<p>In addition to testing, the FL processor could run programs as a
standalone ISA simulator, to verify their functionality before being
run on hardward models.</p>
<section id="helper-classes">
<h2>Helper Classes<a class="headerlink" href="#helper-classes" title="Link to this heading"></a></h2>
<p>As part of the FL processor implementation, many helper classes were
constructed:</p>
<section id="instructions-flinst">
<h3>Instructions (<code class="docutils literal notranslate"><span class="pre">FLInst</span></code>)<a class="headerlink" href="#instructions-flinst" title="Link to this heading"></a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">FLInst</span></code> class wraps an instruction, and provides methods for
accessing the instruction’s type and fields (using the disassembler
helper functions). This makes using the instruction much easier and
understandable (such as using <code class="docutils literal notranslate"><span class="pre">inst.rd()</span></code> instead of bit slicing).
Most methods are also annotated with <code class="docutils literal notranslate"><span class="pre">__attribute__(</span> <span class="pre">(</span> <span class="pre">const</span> <span class="pre">)</span> <span class="pre">)</span></code> to
avoid overhead from multiple calls.</p>
</section>
<section id="register-file-flregfile">
<h3>Register File (<code class="docutils literal notranslate"><span class="pre">FLRegfile</span></code>)<a class="headerlink" href="#register-file-flregfile" title="Link to this heading"></a></h3>
<p>A functional-level register file was implemented in <code class="docutils literal notranslate"><span class="pre">FLRegfile.cpp</span></code>, to
store the state of the architectural registers of the FL processor. The
bracket operator was overloaded to provide concise syntax; however, this
meant that all accesses would provide a <code class="docutils literal notranslate"><span class="pre">uint32_t&amp;</span></code>. To ensure that
<code class="docutils literal notranslate"><span class="pre">x0</span></code> is always read as <code class="docutils literal notranslate"><span class="pre">0</span></code>, <code class="docutils literal notranslate"><span class="pre">regs[0]</span></code> is assigned to <code class="docutils literal notranslate"><span class="pre">0</span></code> on each
access.</p>
</section>
<section id="memory-flmem">
<h3>Memory (<code class="docutils literal notranslate"><span class="pre">FLMem</span></code>)<a class="headerlink" href="#memory-flmem" title="Link to this heading"></a></h3>
<p>A functional-level memory array was implemented in
<code class="docutils literal notranslate"><span class="pre">FLMem.cpp</span></code>, to act as the main memory of the FL Processor. The current
implementation stores data as an <code class="docutils literal notranslate"><span class="pre">std::map</span></code> mapping of address to data
words; while inefficient for large programs (where a static allocation
of a large buffer might be suitable), it worked well for smaller sparse
programs.</p>
<p>In addition to memory data, the <code class="docutils literal notranslate"><span class="pre">FLMem</span></code> stores pointers to
memory-mapped peripherals (see below), and would check each on a memory
access to forward requests appropriately instead of storing data normally.</p>
</section>
<section id="peripherals-flperipheral">
<h3>Peripherals (<code class="docutils literal notranslate"><span class="pre">FLPeripheral</span></code>)<a class="headerlink" href="#peripherals-flperipheral" title="Link to this heading"></a></h3>
<p>In BLIMP, all peripheral devices are memory-mapped. For the FL processor,
these are implemented as derived classes of <code class="docutils literal notranslate"><span class="pre">FLPeripheral</span></code>. The base
class provides a common interface for for accesses; namely, <code class="docutils literal notranslate"><span class="pre">try_read</span></code>
and <code class="docutils literal notranslate"><span class="pre">try_right</span></code> check whether a request is directed for the peripheral,
and perform the operation if so (returning whether the peripheral was used).</p>
<p>Derived classes must implement three functions:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">get_address_ranges</span></code> provides a list of address ranges, where each
range is comprised of start/end addresses (inclusive) and access types
that are allowed (<code class="docutils literal notranslate"><span class="pre">R</span></code>, <code class="docutils literal notranslate"><span class="pre">W</span></code>, or <code class="docutils literal notranslate"><span class="pre">RW</span></code>). This allows the base class
to identify whether a particular access is meant for a peripheral or not.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">read</span></code> and <code class="docutils literal notranslate"><span class="pre">write</span></code> are called with the address and data of a
transaction meant for the peripheral, and should perform any actions
appropriately</p></li>
</ul>
<p>Currently, two FL peripherals are implemented (in <code class="docutils literal notranslate"><span class="pre">fl/peripherals</span></code>) and
used as part of the FL processor:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">FLTerminal</span></code> acts as the standard input and output streams; it can
be read from to provide user input, or written to to display character
output</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">FLExit</span></code> is our mechanism for exiting a simulation; when written to,
it will exit a simulation with that exit code.</p></li>
</ul>
</section>
<section id="instruction-traces-fltrace">
<h3>Instruction Traces (<code class="docutils literal notranslate"><span class="pre">FLTrace</span></code>)<a class="headerlink" href="#instruction-traces-fltrace" title="Link to this heading"></a></h3>
<p>When the processor executes a single instruction, having a “snapshot” of
what the instruction did is useful for verification purposes; gaining
visibility as to what the processor did can identify the first
unexpected change to architectural state. Accordingly, when the FL
processor executes an instruction, an <code class="docutils literal notranslate"><span class="pre">FLTrace</span></code> object is produced,
which contains:</p>
<ul class="simple">
<li><p>The instruction’s address in memory (a.k.a. the PC when it executed)</p></li>
<li><p>Whether the instruction wrote to a register (<code class="docutils literal notranslate"><span class="pre">wen</span></code>)</p></li>
<li><p>The register it wrote to, if applicable (<code class="docutils literal notranslate"><span class="pre">waddr</span></code>)</p></li>
<li><p>The data written to a register, if applicable (<code class="docutils literal notranslate"><span class="pre">wdata</span></code>)</p></li>
</ul>
<p>These can not only be dumped to a text-based format, but can be used
in Verilog to compare with the operations done by RTL models, checking
that both processors produce the same state changes.</p>
</section>
</section>
<section id="functional-level-processor-implementation">
<h2>Functional-Level Processor Implementation<a class="headerlink" href="#functional-level-processor-implementation" title="Link to this heading"></a></h2>
<p>The functional-level processor’s implementation is contained in the
<code class="docutils literal notranslate"><span class="pre">step</span></code> function, which implements one execution step (a.k.a. executes
one instruction). This involved:</p>
<ul class="simple">
<li><p>Getting the instruction at the current PC, wrapping as an <code class="docutils literal notranslate"><span class="pre">FLInst</span></code></p></li>
<li><p>Determining the instruction type using the <code class="docutils literal notranslate"><span class="pre">name</span></code> method</p></li>
<li><p>Using a case statement to execute the correct behavior for the
instruction, returning the appropriate <code class="docutils literal notranslate"><span class="pre">FLTrace</span></code> to reflect the
current PC, the destination, the value of the destination, and
whether the destination was written</p></li>
</ul>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">inst_name</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -</span>
<span class="w">    </span><span class="c1">// add</span>
<span class="w">    </span><span class="c1">// - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -</span>

<span class="w">  </span><span class="k">case</span><span class="w"> </span><span class="no">ADD</span><span class="p">:</span>
<span class="w">    </span><span class="n">regs</span><span class="p">[</span><span class="n">inst</span><span class="p">.</span><span class="n">rd</span><span class="p">()]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">regs</span><span class="p">[</span><span class="n">inst</span><span class="p">.</span><span class="n">rs1</span><span class="p">()]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">regs</span><span class="p">[</span><span class="n">inst</span><span class="p">.</span><span class="n">rs2</span><span class="p">()];</span>
<span class="w">    </span><span class="n">pc</span><span class="w">              </span><span class="o">=</span><span class="w"> </span><span class="n">pc</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">FLTrace</span><span class="p">(</span><span class="w"> </span><span class="n">inst_pc</span><span class="p">,</span><span class="w"> </span><span class="n">inst</span><span class="p">.</span><span class="n">rd</span><span class="p">(),</span><span class="w"> </span><span class="n">regs</span><span class="p">[</span><span class="n">inst</span><span class="p">.</span><span class="n">rd</span><span class="p">()],</span>
<span class="w">                    </span><span class="n">inst</span><span class="p">.</span><span class="n">rd</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">);</span>

<span class="w">    </span><span class="c1">// ...</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="interfacing-with-verilog-testbenches">
<h2>Interfacing with Verilog Testbenches<a class="headerlink" href="#interfacing-with-verilog-testbenches" title="Link to this heading"></a></h2>
</section>
<section id="running-programs-on-the-processor">
<h2>Running Programs on the Processor<a class="headerlink" href="#running-programs-on-the-processor" title="Link to this heading"></a></h2>
</section>
</section>

    <script type="text/javascript">
        function init() {
            WaveDrom.ProcessAll();
        }
        window.onload = init;
    </script>

           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../assembler/" class="btn btn-neutral float-left" title="Assembler and Disassembler" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../../fpga/peripherals/" class="btn btn-neutral float-right" title="Memory-Mapped Peripherals" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Aidan McNay.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>